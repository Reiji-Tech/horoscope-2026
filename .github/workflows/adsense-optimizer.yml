name: AdSense Auto Optimizer

on:
  # ÊØéÈÄ±ÊúàÊõúÊó•„ÅÆÂçàÂâç9ÊôÇÔºàJSTÔºâ„Å´ÂÆüË°å
  schedule:
    - cron: '0 0 * * 1'  # ÊúàÊõúÊó• 09:00 JST (00:00 UTC)
  
  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ
  workflow_dispatch:
    inputs:
      mode:
        description: 'ÂÆüË°å„É¢„Éº„Éâ'
        required: true
        default: 'optimize'
        type: choice
        options:
          - optimize
          - test
          - rollback

jobs:
  adsense-optimization:
    runs-on: ubuntu-latest
    
    steps:
      - name: „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Node.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Python „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ‰æùÂ≠òÈñ¢‰øÇ„Ç§„É≥„Çπ„Éà„Éº„É´
        run: |
          pip install beautifulsoup4 lxml requests
          npm install -g lighthouse
      
      - name: AdSense„Ç≥„Éº„ÉâÊåøÂÖ•„Çπ„ÇØ„É™„Éó„ÉàÂÆüË°å
        env:
          ADSENSE_CLIENT_ID: ${{ secrets.ADSENSE_CLIENT_ID }}
          ADSENSE_SLOT_HEADER: ${{ secrets.ADSENSE_SLOT_HEADER }}
          ADSENSE_SLOT_SIDEBAR: ${{ secrets.ADSENSE_SLOT_SIDEBAR }}
          ADSENSE_SLOT_FOOTER: ${{ secrets.ADSENSE_SLOT_FOOTER }}
        run: python scripts/inject-adsense.py
      
      - name: SEOÊúÄÈÅ©Âåñ
        run: python scripts/optimize-seo.py
      
      - name: „Çµ„Ç§„Éà„Éû„ÉÉ„ÉóÁîüÊàê
        run: python scripts/generate-sitemap.py
      
      - name: robots.txtÁîüÊàê
        run: python scripts/generate-robots.py
      
      - name: Lighthouse„Åß„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÜ„Çπ„Éà
        run: |
          mkdir -p lighthouse-reports
          lighthouse https://reiji-tech.github.io/horoscope-2026/ \
            --output html \
            --output-path ./lighthouse-reports/report.html \
            --chrome-flags="--headless" || true
      
      - name: Â§âÊõ¥„Çí„Ç≥„Éü„ÉÉ„Éà
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git diff --quiet && git diff --staged --quiet || \
          git commit -m "üöÄ AdSenseÊúÄÈÅ©Âåñ: $(date +'%Y-%m-%d')"
      
      - name: „Éó„ÉÉ„Ç∑„É•
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: ÊúÄÈÅ©Âåñ„É¨„Éù„Éº„Éà‰ΩúÊàê
        if: always()
        run: |
          echo "## AdSenseÊúÄÈÅ©Âåñ„É¨„Éù„Éº„Éà" > optimization-report.md
          echo "ÂÆüË°åÊó•ÊôÇ: $(date)" >> optimization-report.md
          echo "ÂØæË±°„Éï„Ç°„Ç§„É´Êï∞: $(find . -name '*.html' | wc -l)" >> optimization-report.md
      
      - name: „É¨„Éù„Éº„Éà„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: optimization-report
          path: |
            optimization-report.md
            lighthouse-reports/
          retention-days: 30
